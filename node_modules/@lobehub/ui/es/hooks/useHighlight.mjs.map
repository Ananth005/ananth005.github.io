{"version":3,"file":"useHighlight.mjs","names":["lines: ThemedToken[][]"],"sources":["../../src/hooks/useHighlight.ts"],"sourcesContent":["'use client';\n\nimport {\n  transformerNotationDiff,\n  transformerNotationErrorLevel,\n  transformerNotationFocus,\n  transformerNotationHighlight,\n  transformerNotationWordHighlight,\n} from '@shikijs/transformers';\nimport { useTheme, useThemeMode } from 'antd-style';\nimport { CSSProperties, useCallback, useEffect, useMemo, useRef, useState } from 'react';\nimport type { BuiltinTheme, CodeToHastOptions, ThemedToken } from 'shiki';\nimport { ShikiStreamTokenizer } from 'shiki-stream';\nimport useSWR, { SWRResponse } from 'swr';\nimport { Md5 } from 'ts-md5';\n\nimport { getCodeLanguageByInput } from '@/Highlighter/const';\n\n// Application-level cache to avoid repeated calculations\nconst MD5_LENGTH_THRESHOLD = 10_000; // Use async MD5 for text exceeding this length\n\n// Color replacement mapping type\ntype ColorReplacements = {\n  [themeName: string]: {\n    [color: string]: string;\n  };\n};\n\ntype StreamingHighlightResult = {\n  colorReplacements?: Record<string, string>;\n  lines: ThemedToken[][];\n  preStyle?: CSSProperties;\n};\n\ntype StreamingOptions = {\n  colorReplacements?: Record<string, string>;\n  enabled?: boolean;\n  language: string;\n  theme: string;\n};\n\ntype UseHighlightResponse = SWRResponse<string, Error> & {\n  colorReplacements?: ColorReplacements;\n  streaming?: StreamingHighlightResult;\n};\n\ntype ICodeToHtml = (code: string, options: CodeToHastOptions) => Promise<string>;\ntype ShikiModule = typeof import('shiki');\n\n// Lazy load shiki\nconst loadShikiModule = (): Promise<ShikiModule | null> => {\n  if (typeof window === 'undefined') return Promise.resolve(null);\n  return import('shiki');\n};\nconst shikiModulePromise = loadShikiModule();\n\nconst loadShiki = (): Promise<ICodeToHtml | null> => {\n  return shikiModulePromise.then((mod) => mod?.codeToHtml ?? null);\n};\nconst shikiPromise = loadShiki();\n\n// Helper function: Safe HTML escaping\nconst escapeHtml = (str: string): string => {\n  return str\n    .replaceAll('&', '&amp;')\n    .replaceAll('<', '&lt;')\n    .replaceAll('>', '&gt;')\n    .replaceAll('\"', '&quot;')\n    .replaceAll(\"'\", '&#039;');\n};\n\nconst tokensToLineTokens = (tokens: ThemedToken[]): ThemedToken[][] => {\n  if (!tokens.length) return [[]];\n\n  const lines: ThemedToken[][] = [[]];\n  let currentLine = lines[0];\n\n  const startNewLine = () => {\n    currentLine = [];\n    lines.push(currentLine);\n  };\n\n  tokens.forEach((token) => {\n    const content = token.content ?? '';\n\n    if (content === '\\n') {\n      startNewLine();\n      return;\n    }\n\n    if (!content.includes('\\n')) {\n      currentLine.push(token);\n      return;\n    }\n\n    const segments = content.split('\\n');\n    segments.forEach((segment, index) => {\n      if (segment) {\n        currentLine.push({\n          ...token,\n          content: segment,\n        });\n      }\n\n      if (index < segments.length - 1) {\n        startNewLine();\n      }\n    });\n  });\n\n  if (lines.length === 0) return [[]];\n\n  return lines;\n};\n\nconst createPreStyle = (bg?: string, fg?: string): CSSProperties | undefined => {\n  if (!bg && !fg) return undefined;\n  return {\n    backgroundColor: bg,\n    color: fg,\n  };\n};\n\nconst useStreamingHighlighter = (\n  text: string,\n  options: StreamingOptions,\n): StreamingHighlightResult | undefined => {\n  const { colorReplacements, enabled, language, theme } = options;\n  const [result, setResult] = useState<StreamingHighlightResult>();\n  const tokenizerRef = useRef<ShikiStreamTokenizer | null>(null);\n  const previousTextRef = useRef('');\n  const safeText = text ?? '';\n  const latestTextRef = useRef(safeText);\n  const preStyleRef = useRef<CSSProperties | undefined>(undefined);\n  const colorReplacementsRef = useRef(colorReplacements);\n  const linesRef = useRef<ThemedToken[][]>([[]]);\n\n  useEffect(() => {\n    latestTextRef.current = safeText;\n  }, [safeText]);\n\n  useEffect(() => {\n    colorReplacementsRef.current = colorReplacements;\n  }, [colorReplacements]);\n\n  const setStreamingResult = useCallback((rawLines: ThemedToken[][]) => {\n    const previousLines = linesRef.current;\n\n    const mergedLines = rawLines.map((line, index) => {\n      const previousLine = previousLines[index];\n      if (\n        previousLine &&\n        previousLine.length === line.length &&\n        previousLine.every((token, tokenIndex) => token === line[tokenIndex])\n      ) {\n        return previousLine;\n      }\n      return line;\n    });\n\n    linesRef.current = mergedLines;\n\n    setResult({\n      colorReplacements: colorReplacementsRef.current,\n      lines: mergedLines,\n      preStyle: preStyleRef.current,\n    });\n  }, []);\n\n  const updateTokens = useCallback(\n    async (nextText: string, forceReset = false) => {\n      const tokenizer = tokenizerRef.current;\n      if (!tokenizer) return;\n\n      if (forceReset) {\n        tokenizer.clear();\n        previousTextRef.current = '';\n      }\n\n      const previousText = previousTextRef.current;\n      let chunk = nextText;\n      const canAppend = !forceReset && nextText.startsWith(previousText);\n\n      if (canAppend) {\n        chunk = nextText.slice(previousText.length);\n      } else if (!forceReset) {\n        tokenizer.clear();\n      }\n\n      previousTextRef.current = nextText;\n\n      if (!chunk) {\n        const mergedTokens = [...tokenizer.tokensStable, ...tokenizer.tokensUnstable];\n        setStreamingResult(mergedTokens.length ? tokensToLineTokens(mergedTokens) : [[]]);\n        return;\n      }\n\n      try {\n        await tokenizer.enqueue(chunk);\n        const mergedTokens = [...tokenizer.tokensStable, ...tokenizer.tokensUnstable];\n        setStreamingResult(tokensToLineTokens(mergedTokens));\n      } catch (error) {\n        console.error('Streaming highlighting failed:', error);\n      }\n    },\n    [setStreamingResult],\n  );\n\n  useEffect(() => {\n    if (!enabled) {\n      tokenizerRef.current?.clear();\n      tokenizerRef.current = null;\n      previousTextRef.current = '';\n      preStyleRef.current = undefined;\n      linesRef.current = [[]];\n      setResult(undefined);\n      return;\n    }\n\n    let cancelled = false;\n\n    (async () => {\n      const mod = await shikiModulePromise;\n      if (!mod || cancelled) return;\n\n      try {\n        const highlighter = await mod.getSingletonHighlighter({\n          langs: language ? [language] : [],\n          themes: [theme],\n        });\n\n        if (!highlighter || cancelled) return;\n\n        const tokenizer = new ShikiStreamTokenizer({\n          highlighter,\n          lang: language,\n          theme,\n        });\n\n        tokenizerRef.current = tokenizer;\n        previousTextRef.current = '';\n        linesRef.current = [[]];\n\n        const themeInfo = highlighter.getTheme(theme);\n        preStyleRef.current = createPreStyle(themeInfo?.bg, themeInfo?.fg);\n\n        const currentText = latestTextRef.current;\n        if (currentText) {\n          await updateTokens(currentText, true);\n        } else {\n          setStreamingResult([[]]);\n        }\n      } catch (error) {\n        console.error('Streaming highlighter initialization failed:', error);\n      }\n    })();\n\n    return () => {\n      cancelled = true;\n      tokenizerRef.current?.clear();\n      tokenizerRef.current = null;\n      previousTextRef.current = '';\n    };\n  }, [enabled, language, setStreamingResult, theme, updateTokens]);\n\n  useEffect(() => {\n    if (!enabled) return;\n    if (!tokenizerRef.current) return;\n    updateTokens(safeText);\n  }, [enabled, safeText, updateTokens]);\n\n  return result;\n};\n\n// Main highlight component\nexport const useHighlight = (\n  text: string,\n  {\n    language,\n    enableTransformer,\n    theme: builtinTheme,\n    streaming,\n  }: { enableTransformer?: boolean; language: string; streaming?: boolean; theme?: BuiltinTheme },\n): UseHighlightResponse => {\n  const { isDarkMode } = useThemeMode();\n  const theme = useTheme();\n\n  // Safely handle language and text with boundary checks\n  const safeText = text ?? '';\n  const lang = (language ?? 'plaintext').toLowerCase();\n\n  // Match supported languages\n  const matchedLanguage = useMemo(() => getCodeLanguageByInput(lang), [lang]);\n\n  // Optimize transformer creation\n  const transformers = useMemo(() => {\n    if (!enableTransformer) return;\n    return [\n      transformerNotationDiff(),\n      transformerNotationHighlight(),\n      transformerNotationWordHighlight(),\n      transformerNotationFocus(),\n      transformerNotationErrorLevel(),\n    ];\n  }, [enableTransformer]);\n\n  // Optimize color replacement configuration\n  const colorReplacements = useMemo(\n    (): ColorReplacements => ({\n      'slack-dark': {\n        '#4ec9b0': theme.yellow,\n        '#569cd6': theme.colorError,\n        '#6a9955': theme.gray,\n        '#9cdcfe': theme.colorText,\n        '#b5cea8': theme.purple10,\n        '#c586c0': theme.colorInfo,\n        '#ce9178': theme.colorSuccess,\n        '#dcdcaa': theme.colorWarning,\n        '#e6e6e6': theme.colorText,\n      },\n      'slack-ochin': {\n        '#002339': theme.colorText,\n        '#0444ac': theme.geekblue,\n        '#0991b6': theme.colorError,\n        '#174781': theme.purple10,\n        '#2f86d2': theme.colorText,\n        '#357b42': theme.gray,\n        '#7b30d0': theme.colorInfo,\n        '#7eb233': theme.colorWarningTextActive,\n        '#a44185': theme.colorSuccess,\n        '#dc3eb7': theme.yellow11,\n      },\n    }),\n    [theme],\n  );\n\n  // Build cache key\n  const cacheKey = useMemo((): string | null => {\n    // Use hash for long text\n    const hash = safeText.length < MD5_LENGTH_THRESHOLD ? safeText : Md5.hashStr(safeText);\n    return [matchedLanguage, builtinTheme || (isDarkMode ? 'd' : 'l'), hash]\n      .filter(Boolean)\n      .join('-');\n  }, [safeText, matchedLanguage, isDarkMode, builtinTheme]);\n\n  // Use SWR to get highlighted HTML\n  const response = useSWR(\n    streaming ? null : cacheKey,\n    async (): Promise<string> => {\n      try {\n        // Try full rendering\n        const codeToHtml = await shikiPromise;\n        if (!codeToHtml) return safeText;\n        const html = await codeToHtml(safeText, {\n          colorReplacements: builtinTheme ? undefined : colorReplacements,\n          lang: matchedLanguage,\n          theme: builtinTheme || (isDarkMode ? 'slack-dark' : 'slack-ochin'),\n          transformers,\n        });\n\n        return html;\n      } catch (error) {\n        console.error('Advanced rendering failed:', error);\n\n        try {\n          // Try simple rendering (without transformers)\n          const codeToHtml = await shikiPromise;\n          if (!codeToHtml) return safeText;\n          const html = await codeToHtml(safeText, {\n            lang: matchedLanguage,\n            theme: isDarkMode ? 'dark-plus' : 'light-plus',\n          });\n          return html;\n        } catch {\n          // Fallback to plain text\n          const fallbackHtml = `<pre class=\"fallback\"><code>${escapeHtml(safeText)}</code></pre>`;\n          return fallbackHtml;\n        }\n      }\n    },\n    {\n      dedupingInterval: 3000, // Only execute once for the same request within 3 seconds\n      errorRetryCount: 2, // Retry at most 2 times\n      revalidateOnFocus: false,\n      revalidateOnReconnect: false,\n    },\n  );\n\n  const effectiveTheme = builtinTheme || (isDarkMode ? 'slack-dark' : 'slack-ochin');\n  const streamingResult = useStreamingHighlighter(safeText, {\n    colorReplacements: builtinTheme ? undefined : colorReplacements[effectiveTheme],\n    enabled: streaming,\n    language: matchedLanguage,\n    theme: effectiveTheme,\n  });\n\n  return {\n    ...response,\n    colorReplacements,\n    streaming: streamingResult,\n  };\n};\n\nexport { escapeHtml, loadShiki, MD5_LENGTH_THRESHOLD, shikiPromise };\n"],"mappings":"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"}