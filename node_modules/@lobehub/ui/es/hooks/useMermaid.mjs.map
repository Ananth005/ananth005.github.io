{"version":3,"file":"useMermaid.mjs","names":["mermaidConfig: MermaidConfig"],"sources":["../../src/hooks/useMermaid.ts"],"sourcesContent":["'use client';\n\nimport { useTheme } from 'antd-style';\nimport type { MermaidConfig } from 'mermaid/dist/config.type';\nimport { useMemo, useState } from 'react';\nimport useSWR, { SWRResponse } from 'swr';\nimport { Md5 } from 'ts-md5';\n\n// 缓存已验证的图表内容\nconst MD5_LENGTH_THRESHOLD = 10_000;\n\n// 懒加载 mermaid 实例\nconst loadMermaid = () => {\n  if (typeof window === 'undefined') return Promise.resolve(null);\n  return import('mermaid').then((mod) => mod.default);\n};\nconst mermaidPromise = loadMermaid();\n\n/**\n * 验证并处理 Mermaid 图表内容\n */\nexport const useMermaid = (\n  content: string,\n  {\n    id,\n    theme: customTheme,\n  }: {\n    id: string;\n    theme?: MermaidConfig['theme'];\n  },\n): SWRResponse<string, Error> => {\n  const theme = useTheme();\n  // 用于存储最近一次有效的内容\n  const [validContent, setValidContent] = useState<string>('');\n\n  // 提取主题相关配置到 useMemo 中\n  const mermaidConfig: MermaidConfig = useMemo(\n    () => ({\n      fontFamily: theme.fontFamilyCode,\n      gantt: {\n        useWidth: 1920,\n      },\n      securityLevel: 'loose',\n      startOnLoad: false,\n      theme: customTheme || (theme.isDarkMode ? 'dark' : 'neutral'),\n      themeVariables: customTheme\n        ? undefined\n        : {\n            errorBkgColor: theme.colorTextDescription,\n            errorTextColor: theme.colorTextDescription,\n            fontFamily: theme.fontFamily,\n            lineColor: theme.colorTextSecondary,\n            mainBkg: theme.colorBgContainer,\n            noteBkgColor: theme.colorInfoBg,\n            noteTextColor: theme.colorInfoText,\n            pie1: theme.geekblue,\n            pie2: theme.colorWarning,\n            pie3: theme.colorSuccess,\n            pie4: theme.colorError,\n            primaryBorderColor: theme.colorBorder,\n            primaryColor: theme.colorBgContainer,\n            primaryTextColor: theme.colorText,\n            secondaryBorderColor: theme.colorInfoBorder,\n            secondaryColor: theme.colorInfoBg,\n            secondaryTextColor: theme.colorInfoText,\n            tertiaryBorderColor: theme.colorSuccessBorder,\n            tertiaryColor: theme.colorSuccessBg,\n            tertiaryTextColor: theme.colorSuccessText,\n            textColor: theme.colorText,\n          },\n    }),\n    [theme.isDarkMode, customTheme],\n  );\n\n  // 为长内容生成哈希键\n  const cacheKey = useMemo((): string => {\n    const hash = content.length < MD5_LENGTH_THRESHOLD ? content : Md5.hashStr(content);\n    return [id, customTheme || (theme.isDarkMode ? 'd' : 'l'), hash].filter(Boolean).join('-');\n  }, [content, id, theme.isDarkMode, customTheme]);\n\n  return useSWR(\n    cacheKey,\n    async (): Promise<string> => {\n      // 检查缓存中是否已验证过\n      try {\n        const mermaidInstance = await mermaidPromise;\n        if (!mermaidInstance) return content;\n\n        // 验证语法\n        const isValid = await mermaidInstance.parse(content);\n\n        if (isValid) {\n          // 更新有效内容状态\n          mermaidInstance.initialize(mermaidConfig);\n          const { svg } = await mermaidInstance.render(id, content);\n          setValidContent(svg);\n          // 缓存验证结果\n          return svg;\n        } else {\n          throw new Error('Mermaid 语法无效');\n        }\n      } catch (error) {\n        if (!validContent) console.error('Mermaid 解析错误:', error);\n        // 返回最近一次有效的内容，或空字符串\n        return validContent || '';\n      }\n    },\n    {\n      dedupingInterval: 3000,\n      errorRetryCount: 2,\n      revalidateOnFocus: false,\n      revalidateOnReconnect: false,\n    },\n  );\n};\n"],"mappings":";;;;;;;;AASA,MAAM,uBAAuB;AAG7B,MAAM,oBAAoB;AACxB,KAAI,OAAO,WAAW,YAAa,QAAO,QAAQ,QAAQ,KAAK;AAC/D,QAAO,OAAO,WAAW,MAAM,QAAQ,IAAI,QAAQ;;AAErD,MAAM,iBAAiB,aAAa;;;;AAKpC,MAAa,cACX,SACA,EACE,IACA,OAAO,kBAKsB;CAC/B,MAAM,QAAQ,UAAU;CAExB,MAAM,CAAC,cAAc,mBAAmB,SAAiB,GAAG;CAG5D,MAAMA,gBAA+B,eAC5B;EACL,YAAY,MAAM;EAClB,OAAO,EACL,UAAU,MACX;EACD,eAAe;EACf,aAAa;EACb,OAAO,gBAAgB,MAAM,aAAa,SAAS;EACnD,gBAAgB,cACZ,SACA;GACE,eAAe,MAAM;GACrB,gBAAgB,MAAM;GACtB,YAAY,MAAM;GAClB,WAAW,MAAM;GACjB,SAAS,MAAM;GACf,cAAc,MAAM;GACpB,eAAe,MAAM;GACrB,MAAM,MAAM;GACZ,MAAM,MAAM;GACZ,MAAM,MAAM;GACZ,MAAM,MAAM;GACZ,oBAAoB,MAAM;GAC1B,cAAc,MAAM;GACpB,kBAAkB,MAAM;GACxB,sBAAsB,MAAM;GAC5B,gBAAgB,MAAM;GACtB,oBAAoB,MAAM;GAC1B,qBAAqB,MAAM;GAC3B,eAAe,MAAM;GACrB,mBAAmB,MAAM;GACzB,WAAW,MAAM;GAClB;EACN,GACD,CAAC,MAAM,YAAY,YAAY,CAChC;AAQD,QAAO,OALU,cAAsB;EACrC,MAAM,OAAO,QAAQ,SAAS,uBAAuB,UAAU,IAAI,QAAQ,QAAQ;AACnF,SAAO;GAAC;GAAI,gBAAgB,MAAM,aAAa,MAAM;GAAM;GAAK,CAAC,OAAO,QAAQ,CAAC,KAAK,IAAI;IACzF;EAAC;EAAS;EAAI,MAAM;EAAY;EAAY,CAAC,EAI9C,YAA6B;AAE3B,MAAI;GACF,MAAM,kBAAkB,MAAM;AAC9B,OAAI,CAAC,gBAAiB,QAAO;AAK7B,OAFgB,MAAM,gBAAgB,MAAM,QAAQ,EAEvC;AAEX,oBAAgB,WAAW,cAAc;IACzC,MAAM,EAAE,QAAQ,MAAM,gBAAgB,OAAO,IAAI,QAAQ;AACzD,oBAAgB,IAAI;AAEpB,WAAO;SAEP,OAAM,IAAI,MAAM,eAAe;WAE1B,OAAO;AACd,OAAI,CAAC,aAAc,SAAQ,MAAM,iBAAiB,MAAM;AAExD,UAAO,gBAAgB;;IAG3B;EACE,kBAAkB;EAClB,iBAAiB;EACjB,mBAAmB;EACnB,uBAAuB;EACxB,CACF"}